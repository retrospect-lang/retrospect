// Based on https://code.earthengine.google.com/b26d304f61f2296408138a7bbbfb054d
scale = size * size / 100
b0 = testBand(size * 0.3, size * 0.3, scale)
b1 = testBand(size * 0.3, size * 0.7, scale)
b2 = testBand(size * 0.7 , size * 0.5, scale)
img = { b0, b1, b2 }

// Create a (lazily-computed) collection of features
// Note that pixelCoordinates() returns the coordinates of pixel centers, hence
// the 0.5 shift.
// (And it's negative because our matrices are indexed from 1, not 0).
features = matrix([size, size])
             | [i, j] -> feature([i - 0.5, j - 0.5], img)

centroids =
    [[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55]]

// Classify each feature and return a histogram of the results
return features
     | f -> classify(f, centroids)
     | f -> f.class
     | histogram(0, size(centroids), size(centroids))

function testBand(xc, yc, scale) =
    [x, y] -> testBandHelper([x, y] - [xc, yc], scale)

function testBandHelper(delta, scale) {
  d = delta ** 2
  d2 = d[2] + d[1]
  return 1 / (log(d2 / scale + 7 - 6) + 1)
}

// Evaluate each of the bands at the given xy coordinates and save the results
// as a struct.
function feature(xy, bands) = bands | b -> b @ xy | save

// Translation of the "classify()" function in the code editor script, which
// "given a feature with properties b0, b1, and b2, adds a class property with
// the index of the closest centroid" (using Euclidean distance as its
// similarity metric).
function classify(f, centroids) {
  b0 = f.b0
  b1 = f.b1
  b2 = f.b2
  pt = [b0, b1, b2]
  // If we were writing idiomatic Retrospect we'd do something more like
  //
  //     distances = 1..5 | i -> [dist(pt, centroids[i]), i - 1]
  //
  // ... but we're approximating the results of translating the EE expression,
  // where the loop is on the client side.
  distances = [[dist(pt, centroids[1]), 0],
               [dist(pt, centroids[2]), 1],
               [dist(pt, centroids[3]), 2],
               [dist(pt, centroids[4]), 3],
               [dist(pt, centroids[5]), 4]]
  min = distances | minAt([1])
  return {b0, b1, b2, class: min[2]}
}

function dist(pt, centroid) = (centroid - pt) ** 2 | sum

// We don't yet have a (fixed) histogram reducer in Retrospect,
// but it's easy enough to implement.

compound Histogram is Reducer

function histogram(min, max, steps) =
    Histogram_({min, scale: steps / (max - min), steps})

method emptyState(Histogram h) = newMatrix([h_.steps], 0)

method nextState(Histogram h, state, value) {
  b = 1 + floor((value - h_.min) * h_.scale)
  if b >= 1 and b <= size(state) {
    state[b] += 1
  }
  return state
}

method combineStates(Histogram, state1, state2) = state1 + state2

/* RUN (size=200) CODEGEN(10) RETURNS
[10838, 7456, 7456, 8110, 6140]
---
?0--------------1-?0-1+..+?0-----------.?-----------.--2-?0-----------.-2-?0-------------2-?0-2+...+0------..?---1+..++..++..+2+...++...++...++...++...+.....0-1+..++..++..+2+...++...++...++...+3bsr.....0-1+..++..++..+srsrsrsrsr.....4+5bsrsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+5srsrsr3srsrsrsrsr.....+6bs(3:170,5:102)[?⊝0-⊝-..⊝-?⊝-?⊝-?⊝-?⊝-?⊝-⊝-5srsrsr3srsrsrsrsr.....6⊝-5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕5srsrsr3srsrsrsrsr.....6⊕7bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕8bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊚-s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕9bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕10bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕11bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕12bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕13bs(3:5,5:3)[⊕s(3:5,5:3)[⊚-5srsrsr3srsrsrsrsr.....13⊝-5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕5srsrsr3srsrsrsrsr.....13⊕14bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕15bs(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊚-s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕s(3:5,5:3)[⊕16bs(3:175,5:105)[?⊝-5srsrsr3srsrsrsrsr.....?16⊝-⊝-⊝-5srsrsr3srsrsrsrsr.....4*5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕5srsrsr3srsrsrsrsr.....16⊕17bs(3:18440,5:11064)[⊝0-5srsrsr3srsrsrsrsr.....17⊝-5srsrsr3srsrsrsrsr.....17⊝-5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕5srsrsr3srsrsrsrsr.....17⊕18bs(3:98660,5:59196)[⊝-5srsrsr3srsrsrsrsr.....18⊝-5srsrsr3srsrsrsrsr.....18⊝-5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕5srsrsr3srsrsrsrsr.....18⊕19bs(3:81720,5:49032)[?⊝-⊝-]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]-
  0: x (top level)
  1: x sample_bench_1.r8t+1:34
  2: x sample_bench_1.r8t+1:60
  3: dist_x0 (2)
  4: r LoopCore.Iterate // LoopCore.enumerateDefault // LoopCore.PipeCollectionCollector.enumerate // sample_bench_1.r8t+1:18_20 _t0 = pipe(_t0, _t1)
  5: at_x1 (1)
  6: iterate_r2 (4)
  7: iterate_r3 (4)
  8: iterate_r4 (4)
  9: iterate_r5 (4)
 10: iterate_r6 (4)
 11: iterate_r7 (4)
 12: iterate_r8 (4)
 13: iterate_r9 (4)
 14: iterate_r10 (4)
 15: iterate_r11 (4)
 16: iterate_r12 (4)
 17: iterate_r13 (4)
 18: iterate_r14 (4)
 19: iterate_r15 (4)
---
allocated=842672/31389, peak=184
*/
